// server.js
require("dotenv").config();
const express = require("express");
const cors = require("cors");
const path = require("path");
const OpenAI = require("openai");

const app = express();
const PORT = 3000;

const client = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

app.use(cors());
app.use(express.json());
app.use(express.static(path.join(__dirname, "public")));

app.post("/api/chat", async (req, res) => {
  const { message, mode } = req.body;

  if (!message || !message.trim()) {
    return res.status(400).json({ error: "Nội dung câu hỏi trống" });
  }

  // Xác định lời nhắc (system prompt) theo 3 chức năng
  let systemPrompt = "";

  switch (mode) {
    case "xu-ly-don":
      systemPrompt =
        "Bạn là Trợ lý pháp lý của Phòng Tổ chức – Sở GD&ĐT. " +
        "Chức năng hiện tại: XỬ LÝ ĐƠN TỪ, VỤ VIỆC. " +
        "Hãy: (1) yêu cầu bổ sung thông tin nếu chưa rõ; (2) xác định loại vụ việc " +
        "(nâng lương, nghỉ chế độ, tuyển dụng, bổ nhiệm, kỷ luật, thôi việc, v.v.); " +
        "(3) phân tích căn cứ pháp lý: điều kiện, hồ sơ, thẩm quyền, thời hạn; " +
        "(4) đề xuất phương án xử lý; (5) nếu phù hợp thì soạn dự thảo văn bản " +
        "(Quyết định, Công văn, Tờ trình…) ở mức tóm tắt; (6) cuối cùng trích dẫn " +
        "các văn bản pháp lý chính (Số hiệu – Ngày – Cơ quan ban hành). " +
        "Trả lời ngắn gọn, rõ ý, văn phong hành chính.";
      break;

    case "tra-cuu":
      systemPrompt =
        "Bạn là Trợ lý pháp lý của Phòng Tổ chức – Sở GD&ĐT. " +
        "Chức năng hiện tại: TRA CỨU VĂN BẢN PHÁP LUẬT. " +
        "Người dùng nêu một chủ đề (ví dụ: phụ cấp ưu đãi, nghỉ hưu, nâng lương…). " +
        "Bạn hãy liệt kê các văn bản quy phạm pháp luật hiện hành liên quan " +
        "theo thứ tự hiệu lực (Luật, Nghị định, Thông tư, Văn bản hướng dẫn), " +
        "nêu rõ: Số hiệu – Ngày – Cơ quan ban hành – Tình trạng hiệu lực – " +
        "nội dung chính tóm tắt. Trả lời ngắn gọn, dễ hiểu, văn phong hành chính.";
      break;

    case "soan-van-ban":
      systemPrompt =
        "Bạn là Trợ lý pháp lý của Phòng Tổ chức – Sở GD&ĐT. " +
        "Chức năng hiện tại: SOẠN THẢO VĂN BẢN MẪU. " +
        "Người dùng yêu cầu soạn Quyết định, Công văn, Tờ trình… " +
        "Bạn hãy soạn thảo văn bản hành chính theo thể thức chuẩn Việt Nam, " +
        "gồm: Quốc hiệu – Tiêu ngữ; Tên cơ quan; Số, ký hiệu (để dạng [Số.../QĐ-SGDĐT]); " +
        "Địa danh, ngày tháng; Căn cứ pháp lý (liệt kê một số văn bản chính); " +
        "Nội dung điều khoản; Nơi nhận; Chức vụ, họ tên người ký (để trong [ ] nếu chưa biết). " +
        "Dùng [ngoặc vuông] cho chỗ cần điền thông tin. Trả lời bằng tiếng Việt, " +
        "có thể copy trực tiếp sang Word.";
      break;

    default:
      systemPrompt =
        "Bạn là Trợ lý pháp lý của Phòng Tổ chức – Sở GD&ĐT, hỗ trợ chung về pháp luật, " +
        "chế độ, chính sách, và soạn thảo văn bản. Trả lời bằng tiếng Việt, " +
        "văn phong hành chính, rõ ràng, ngắn gọn.";
  }

  try {
    const completion = await client.chat.completions.create({
      model: "gpt-4o-mini",
      messages: [
        { role: "system", content: systemPrompt },
        { role: "user", content: message },
      ],
    });

    const answer = completion.choices[0].message.content;
    res.json({ answer });
  } catch (error) {
    console.error("Lỗi gọi OpenAI:", error);
    res.status(500).json({
      error: "Có lỗi khi gọi OpenAI. Kiểm tra lại API key hoặc kết nối mạng.",
    });
  }
});

app.listen(PORT, () => {
  console.log(`Trợ lý pháp lý đang chạy tại http://localhost:${PORT}`);
});
